<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>è¿›é˜¶è´·æ¬¾è®¡ç®—å™¨</title>
        <style>
            /* --- åŸºæœ¬æ ·å¼ --- */
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                line-height: 1.6;
                background-color: #f4f7f9;
                color: #333;
                padding: 20px;
            }
            .container {
                max-width: 1200px;
                margin: auto;
                background: #fff;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            h2 {
                border-bottom: 2px solid #007bff;
                padding-bottom: 10px;
                margin-top: 30px;
                color: #007bff;
            }
            button {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 15px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                margin: 4px 2px;
                cursor: pointer;
                border-radius: 4px;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #0056b3;
            }
            .input-group {
                margin-bottom: 15px;
                display: flex;
                align-items: center;
            }
            .input-group label {
                width: 120px;
                font-weight: bold;
                margin-right: 10px;
            }
            .input-group input,
            .input-group select {
                flex-grow: 1;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
            }
            .flex-row {
                display: flex;
                justify-content: space-between;
                gap: 20px;
            }
            .loan-list-item,
            .type-list-item {
                background: #e9f7fe;
                border: 1px solid #cce9ff;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 6px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .loan-details-table th,
            .loan-details-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: right;
            }
            .loan-details-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .loan-details-table th {
                background-color: #f2f2f2;
                text-align: center;
            }
            .summary-box {
                background-color: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
                padding: 15px;
                margin-top: 20px;
                border-radius: 4px;
                font-weight: bold;
            }
            .hidden {
                display: none;
            }

            /* ... (åŸæœ‰æ ·å¼) ... */
            .rate-change-container {
                border: 1px solid #ffc107;
                padding: 15px;
                margin-top: 15px;
                border-radius: 4px;
                background-color: #fff9e6;
            }
            .rate-change-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #fff;
                padding: 8px;
                margin-bottom: 5px;
                border-radius: 3px;
                border-left: 4px solid #ffc107;
            }
            .rate-change-item button {
                margin-left: 10px;
                background-color: #dc3545;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ’° è´·æ¬¾è®¡ç®—å™¨</h1>

            <div id="type-library-view">
                <h2>ğŸ“š è´·æ¬¾ç±»å‹åº“</h2>
                <div id="type-list"></div>

                <button onclick="showCreateLoanTypeForm()">
                    + æ·»åŠ æ–°è´·æ¬¾ç±»å‹
                </button>

                <div id="create-type-form" class="hidden">
                    <h3>åˆ›å»º/ç¼–è¾‘è´·æ¬¾ç±»å‹</h3>
                    <div class="input-group">
                        <label for="typeName">ç±»å‹åç§°:</label>
                        <input type="text" id="typeName" value="æ–°ç±»å‹" />
                    </div>
                    <div class="input-group">
                        <label for="typeRate">åŸºç¡€å¹´åˆ©ç‡ (%):</label>
                        <input
                            type="number"
                            id="typeRate"
                            value="3.5"
                            step="0.01"
                        />
                    </div>
                    <div class="input-group">
                        <label for="typeMonths">æ€»è¿˜æ¬¾æœˆæ•°:</label>
                        <input type="number" id="typeMonths" value="360" />
                    </div>
                    <div class="input-group">
                        <label for="typeStart">å¼€å§‹è¿˜æ¬¾å¹´æœˆ:</label>
                        <input type="month" id="typeStart" value="2024-01" />
                    </div>
                    <div class="input-group">
                        <label for="typeMethod">è¿˜æ¬¾æ–¹å¼:</label>
                        <select id="typeMethod">
                            <option value="equalPrincipalInterest">
                                ç­‰é¢æœ¬æ¯
                            </option>
                            <option value="equalPrincipal">ç­‰é¢æœ¬é‡‘</option>
                        </select>
                        <div class="rate-change-container">
                            <h4>åˆ©ç‡å˜åŒ–è®°å½•</h4>
                            <div id="rate-changes-list"></div>
                            <div class="input-group">
                                <label for="newRateStartDate">å¼€å§‹å¹´æœˆ:</label>
                                <input type="month" id="newRateStartDate" />
                            </div>
                            <div class="input-group">
                                <label for="newRateValue">æ–°åˆ©ç‡ (%):</label>
                                <input
                                    type="number"
                                    id="newRateValue"
                                    step="0.01"
                                />
                            </div>
                            <button
                                onclick="addRateChange()"
                                style="background-color: #28a745"
                            >
                                + æ·»åŠ åˆ©ç‡å˜åŒ–
                            </button>
                        </div>
                        <button onclick="saveLoanType()">ä¿å­˜ç±»å‹</button>
                        <button onclick="hideCreateLoanTypeForm()">å–æ¶ˆ</button>
                    </div>
                    <button onclick="saveLoanType()">ä¿å­˜ç±»å‹</button>
                    <button onclick="hideCreateLoanTypeForm()">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="my-loans-view">
                <h2>ğŸ’µ æˆ‘çš„è´·æ¬¾</h2>
                <div id="loan-list"></div>
                <button onclick="showCreateMyLoanForm()">+ æ·»åŠ æ–°è´·æ¬¾</button>
            </div>

            <div id="create-loan-form" class="hidden">
                <h3>åˆ›å»º/ç¼–è¾‘æˆ‘çš„è´·æ¬¾</h3>
                <div class="input-group">
                    <label for="myLoanName">è´·æ¬¾åç§°:</label>
                    <input type="text" id="myLoanName" value="æˆ¿è´·ç»„åˆ" />
                </div>
                <div class="input-group">
                    <label for="myLoanAmount">æ€»è´·æ¬¾é‡‘é¢ (ä¸‡å…ƒ):</label>
                    <input
                        type="number"
                        id="myLoanAmount"
                        value="100"
                        step="1"
                    />
                </div>
                <button onclick="saveMyLoan()">ä¿å­˜å¹¶æŸ¥çœ‹è¯¦æƒ…</button>
                <button onclick="renderMyLoansView()">è¿”å›åˆ—è¡¨</button>
            </div>

            <div id="loan-detail-view" class="hidden">
                <h3 id="detail-loan-name">è´·æ¬¾è¯¦æƒ…</h3>
                <p>æ€»è´·æ¬¾é‡‘é¢ï¼š<span id="detail-total-amount"></span> ä¸‡å…ƒ</p>

                <h4>ğŸ§© è´·æ¬¾åˆ†é¡¹</h4>
                <div id="loan-subitems"></div>
                <button onclick="addSubItem()">+ æ·»åŠ è´·æ¬¾åˆ†é¡¹</button>

                <h4>ğŸ“Š è®¡ç®—ç»“æœæ‘˜è¦</h4>
                <div class="summary-box">
                    æ€»åˆ©æ¯æ”¯å‡º: <span id="summary-interest">0.00</span> å…ƒ |
                    è¿˜æ¬¾æ€»é¢: <span id="summary-total-repay">0.00</span> å…ƒ
                </div>

                <h4>ğŸ—“ï¸ è¯¦ç»†è¿˜æ¬¾è®¡åˆ’</h4>
                <table class="loan-details-table">
                    <thead>
                        <tr>
                            <th>æœŸæ•°</th>
                            <th>å¹´æœˆ</th>
                            <th>æœˆè¿˜æ¬¾é¢(å…ƒ)</th>
                            <th>è¿˜æ¬¾æœ¬é‡‘(å…ƒ)</th>
                            <th>è¿˜æ¬¾åˆ©æ¯(å…ƒ)</th>
                            <th>å‰©ä½™æœ¬é‡‘(å…ƒ)</th>
                        </tr>
                    </thead>
                    <tbody id="repayment-schedule"></tbody>
                </table>

                <button onclick="calculateAndRenderDetails()">é‡æ–°è®¡ç®—</button>
                <button onclick="renderMyLoansView()">è¿”å›åˆ—è¡¨</button>
            </div>
        </div>

        <script>
            // --- æ ¸å¿ƒæ•°æ®å­˜å‚¨ (æ¨¡æ‹Ÿæ•°æ®åº“) ---
            let LOAN_TYPES = [
                {
                    id: "t1",
                    name: "å…¬ç§¯é‡‘è´·æ¬¾",
                    rate: 3.1,
                    months: 360,
                    start: "2024-01",
                    method: "equalPrincipalInterest",
                    rateChanges: [],
                },
                {
                    id: "t2",
                    name: "å•†ä¸šè´·æ¬¾",
                    rate: 4.5,
                    months: 360,
                    start: "2024-01",
                    method: "equalPrincipalInterest",
                    rateChanges: [{ startDate: "2025-01", rate: 4.3 }],
                },
            ];
            let MY_LOANS = [
                {
                    id: "l1",
                    name: "é¦–å¥—æˆ¿è´·",
                    totalAmount: 100,
                    subItems: [
                        { id: "s1a", typeId: "t1", amount: 80, prepayment: [] },
                        { id: "s1b", typeId: "t2", amount: 20, prepayment: [] },
                    ],
                },
            ];

            // --- çŠ¶æ€ç®¡ç†å˜é‡ ---
            let currentLoanId = null;
            let nextTypeId = LOAN_TYPES.length + 1;
            let nextLoanId = MY_LOANS.length + 1;
            let editingTypeId = null; // ç”¨äºè·Ÿè¸ªå½“å‰æ­£åœ¨ç¼–è¾‘çš„è´·æ¬¾ç±»å‹ ID

            // ä¸´æ—¶å­˜å‚¨å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç±»å‹çš„åˆ©ç‡å˜åŒ–ï¼ˆé‡è¦ï¼šç”¨äºåœ¨ç‚¹å‡»â€œä¿å­˜â€å‰è¿›è¡Œç®¡ç†ï¼‰
            let currentRateChanges = [];

            // --- æ ¸å¿ƒè®¡ç®—é€»è¾‘æŠ½è±¡ (ä¾¿äºæ›¿æ¢ï¼Œä¾‹å¦‚æ›¿æ¢ä¸ºWASM) ---
            class LoanCalculator {
                /**
                 * è·å–ç»™å®šæœˆä»½çš„å¹´åˆ©ç‡ã€‚
                 * @param {number} baseRate åŸºç¡€å¹´åˆ©ç‡ (e.g., 0.045)
                 * @param {string} dateString YYYY-MM æ ¼å¼
                 * @param {Array} rateChanges åˆ©ç‡å˜åŒ–åˆ—è¡¨ ({startDate: 'YYYY-MM', rate: 4.3})
                 * @returns {number} å½“æœˆå¹´åˆ©ç‡ (å°æ•°)
                 */
                static getEffectiveRate(baseRate, dateString, rateChanges) {
                    let rate = baseRate; // åŸºç¡€åˆ©ç‡ (å°æ•°)

                    // ç¡®ä¿ rateChanges æŒ‰ç…§ startDate å‡åºæ’åˆ—ï¼Œä»¥ä¾¿æŒ‰æ—¶é—´çº¿æŸ¥æ‰¾
                    const sortedChanges = rateChanges.sort((a, b) =>
                        a.startDate.localeCompare(b.startDate),
                    );

                    for (const change of sortedChanges) {
                        // å¦‚æœå½“å‰æœˆä»½å¤§äºæˆ–ç­‰äºå˜åŒ–å¼€å§‹æœˆä»½ï¼Œåˆ™é‡‡ç”¨æ–°çš„åˆ©ç‡
                        if (dateString >= change.startDate) {
                            rate = change.rate / 100; // å°† % è½¬æ¢ä¸ºå°æ•°
                        }
                    }
                    return rate;
                }

                /**
                 * è®¡ç®—ç­‰é¢æœ¬æ¯ (Equal Principal and Interest) æœˆè¿˜æ¬¾é¢
                 * @param {number} principal å‰©ä½™æœ¬é‡‘ (å…ƒ)
                 * @param {number} monthlyRate æœˆåˆ©ç‡ (å°æ•°)
                 * @param {number} remainingMonths å‰©ä½™æœˆæ•°
                 * @returns {number} æœˆè¿˜æ¬¾é¢
                 */
                static calculateEPI(principal, monthlyRate, remainingMonths) {
                    if (remainingMonths <= 0) return 0;
                    if (monthlyRate === 0) return principal / remainingMonths;
                    const powerFactor = Math.pow(
                        1 + monthlyRate,
                        remainingMonths,
                    );
                    return (
                        (principal * monthlyRate * powerFactor) /
                        (powerFactor - 1)
                    );
                }

                /**
                 * è®¡ç®—è¿˜æ¬¾æ˜ç»† (ç­‰é¢æœ¬æ¯/ç­‰é¢æœ¬é‡‘)
                 * @param {number} totalPrincipal æ€»è´·æ¬¾æœ¬é‡‘ (å…ƒ)
                 * @param {number} totalMonths æ€»è¿˜æ¬¾æœˆæ•°
                 * @param {string} startDateString YYYY-MM
                 * @param {string} method è¿˜æ¬¾æ–¹å¼ ('equalPrincipalInterest' / 'equalPrincipal')
                 * @param {number} baseRate åŸºç¡€å¹´åˆ©ç‡ (å°æ•°)
                 * @param {Array} rateChanges åˆ©ç‡å˜åŒ–
                 * @param {Array} prepayments æå‰è¿˜æ¬¾è®¡åˆ’ (amount æ˜¯ä¸‡å…ƒ)
                 * @returns {Array} è¿˜æ¬¾è®¡åˆ’æ˜ç»†
                 */
                static calculateSchedule(
                    totalPrincipal,
                    totalMonths,
                    startDateString,
                    method,
                    baseRate,
                    rateChanges,
                    prepayments,
                ) {
                    let schedule = [];
                    let remainingPrincipal = totalPrincipal;
                    let totalInterest = 0;
                    let currentMonthIndex = 0; // ä» 1 å¼€å§‹è®¡æ•°

                    // å°† YYYY-MM è½¬æ¢ä¸º Date å¯¹è±¡
                    const startDate = new Date(startDateString + "-01");

                    // ç”¨äºç­‰é¢æœ¬æ¯ï¼šè®°å½•æœˆä¾›çš„æœŸæœ›å€¼ã€‚å½“åˆ©ç‡æˆ–æœ¬é‡‘å˜åŒ–æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—ã€‚
                    let currentEpiPayment = 0;
                    let needRecalculateEPI = true;
                    let previousAnnualRate = null;

                    while (
                        remainingPrincipal > 0 &&
                        currentMonthIndex < totalMonths
                    ) {
                        currentMonthIndex++;

                        // è®¡ç®—å½“å‰å¹´æœˆ
                        const currentDate = new Date(
                            startDate.getFullYear(),
                            startDate.getMonth() + currentMonthIndex - 1,
                            1,
                        );
                        const currentMonthString =
                            currentDate.getFullYear() +
                            "-" +
                            String(currentDate.getMonth() + 1).padStart(2, "0");

                        // 1. è·å–å½“æœˆåˆ©ç‡ (å°æ•°)
                        const annualRate = LoanCalculator.getEffectiveRate(
                            baseRate,
                            currentMonthString,
                            rateChanges,
                        );
                        const monthlyRate = annualRate / 12;

                        // æ£€æŸ¥åˆ©ç‡æ˜¯å¦å˜åŒ–
                        if (annualRate !== previousAnnualRate) {
                            needRecalculateEPI = true;
                            previousAnnualRate = annualRate;
                        }

                        // 2. å¤„ç†æå‰è¿˜æ¬¾ (æœ¬é‡‘å‡å°‘)
                        // æå‰è¿˜æ¬¾çš„é‡‘é¢éœ€è¦ä»ä¸‡å…ƒè½¬æ¢ä¸ºå…ƒ
                        const monthPrepayment =
                            (
                                prepayments.find(
                                    (p) => p.month === currentMonthString,
                                ) || { amount: 0 }
                            ).amount * 10000;

                        // 3. è®¡ç®—åˆ©æ¯
                        const interest = remainingPrincipal * monthlyRate;

                        let monthlyRepayment;
                        let principalRepayment;

                        if (method === "equalPrincipalInterest") {
                            // ç­‰é¢æœ¬æ¯ï¼šå¦‚æœåˆ©ç‡æˆ–æœ¬é‡‘æœ‰å˜ï¼Œé‡æ–°è®¡ç®—å‰©ä½™æœŸé™çš„æœˆä¾›
                            if (needRecalculateEPI) {
                                const effectiveMonths =
                                    totalMonths - currentMonthIndex + 1; // å‰©ä½™æœŸé™
                                currentEpiPayment = LoanCalculator.calculateEPI(
                                    remainingPrincipal,
                                    monthlyRate,
                                    effectiveMonths,
                                );
                                needRecalculateEPI = false;
                            }

                            principalRepayment = currentEpiPayment - interest;
                            monthlyRepayment = currentEpiPayment;
                        } else if (method === "equalPrincipal") {
                            // ç­‰é¢æœ¬é‡‘ï¼šæ¯æœˆè¿˜æœ¬é‡‘å›ºå®š (ä¸å—åˆ©ç‡å˜åŒ–å½±å“)
                            const fixedPrincipal = totalPrincipal / totalMonths;
                            principalRepayment = fixedPrincipal;
                            monthlyRepayment = principalRepayment + interest;
                        }

                        // å¦‚æœç­‰é¢æœ¬æ¯çš„æœ¬é‡‘å¿è¿˜é¢å°äº0ï¼ˆé€šå¸¸ä¸ä¼šå‘ç”Ÿï¼‰ï¼Œè®¾ä¸º0
                        if (principalRepayment < 0) principalRepayment = 0;

                        // 4. æœ€ç»ˆç¡®å®šæœ¬é‡‘å¿è¿˜é¢ (è€ƒè™‘æå‰è¿˜æ¬¾)
                        let actualPrincipalRepaid =
                            principalRepayment + monthPrepayment;
                        let actualMonthlyRepayment =
                            monthlyRepayment + monthPrepayment;

                        // é¿å…æœ€åä¸€æœŸè¶…é¢è¿˜æ¬¾
                        if (actualPrincipalRepaid > remainingPrincipal) {
                            actualPrincipalRepaid = remainingPrincipal;
                            actualMonthlyRepayment =
                                remainingPrincipal + interest; // æœ€åä¸€æœŸè¿˜æ¬¾é¢ = å‰©ä½™æœ¬é‡‘ + å½“æœˆåˆ©æ¯
                        }

                        // å¦‚æœå‘ç”Ÿäº†æå‰è¿˜æ¬¾ï¼Œéœ€è¦æ ‡è®°ç­‰é¢æœ¬æ¯ä¸‹ä¸€æœŸéœ€è¦é‡æ–°è®¡ç®—æœˆä¾›
                        if (
                            monthPrepayment > 0 &&
                            method === "equalPrincipalInterest"
                        ) {
                            needRecalculateEPI = true;
                        }

                        remainingPrincipal -= actualPrincipalRepaid;
                        totalInterest += interest;

                        schedule.push({
                            monthIndex: currentMonthIndex,
                            date: currentMonthString,
                            monthlyRepayment: actualMonthlyRepayment,
                            principalRepayment: actualPrincipalRepaid,
                            interest: interest,
                            remainingPrincipal:
                                remainingPrincipal > 0.01
                                    ? remainingPrincipal
                                    : 0,
                        });

                        if (remainingPrincipal <= 0.01) break; // å·²è¿˜æ¸…
                    }

                    return { schedule, totalInterest };
                }
            }

            // --- UI æ¸²æŸ“å’Œäº‹ä»¶å¤„ç† ---

            /**
             * æ¸²æŸ“è´·æ¬¾ç±»å‹åˆ—è¡¨
             */
            function renderLoanTypes() {
                const list = document.getElementById("type-list");
                list.innerHTML = "";
                LOAN_TYPES.forEach((type) => {
                    const changesCount = type.rateChanges.length;
                    const changesText =
                        changesCount > 0 ? `(${changesCount}æ¬¡åˆ©ç‡å˜åŒ–)` : "";
                    const div = document.createElement("div");
                    div.className = "type-list-item";
                    div.innerHTML = `
                        <div>
                            <strong>${type.name}</strong> (${type.method === "equalPrincipalInterest" ? "ç­‰é¢æœ¬æ¯" : "ç­‰é¢æœ¬é‡‘"})<br>
                            åŸºç¡€åˆ©ç‡: ${type.rate}% | æœŸé™: ${type.months}ä¸ªæœˆ ${changesText}
                        </div>
                        <div>
                            <button onclick="editLoanType('${type.id}')">ç¼–è¾‘</button>
                            <button style="background-color: #dc3545;" onclick="deleteLoanType('${type.id}')">åˆ é™¤</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            /**
             * æ¸²æŸ“åˆ©ç‡å˜åŒ–åˆ—è¡¨ UI
             */
            function renderRateChangesList() {
                const listContainer =
                    document.getElementById("rate-changes-list");
                listContainer.innerHTML = "";

                // æŒ‰æ—¶é—´æ’åºæ˜¾ç¤º
                const sortedChanges = currentRateChanges.sort((a, b) =>
                    a.startDate.localeCompare(b.startDate),
                );

                sortedChanges.forEach((change, index) => {
                    const div = document.createElement("div");
                    div.className = "rate-change-item";
                    div.innerHTML = `
                        <span>ä» <strong>${change.startDate}</strong> å¼€å§‹ï¼Œæ–°åˆ©ç‡ä¸º <strong>${change.rate}%</strong></span>
                        <button onclick="removeRateChange(${index})">ç§»é™¤</button>
                    `;
                    listContainer.appendChild(div);
                });

                if (sortedChanges.length === 0) {
                    listContainer.innerHTML =
                        '<p style="color:#6c757d;">æš‚æ— åˆ©ç‡å˜åŒ–è®°å½•ã€‚</p>';
                }
            }

            /**
             * æ·»åŠ æ–°çš„åˆ©ç‡å˜åŒ–è®°å½•åˆ°ä¸´æ—¶æ•°ç»„
             */
            function addRateChange() {
                const startDate =
                    document.getElementById("newRateStartDate").value;
                const rateValue = parseFloat(
                    document.getElementById("newRateValue").value,
                );

                if (!startDate || isNaN(rateValue) || rateValue <= 0) {
                    alert("è¯·å¡«å†™æœ‰æ•ˆçš„å¼€å§‹å¹´æœˆå’Œæ–°åˆ©ç‡ï¼");
                    return;
                }

                currentRateChanges.push({
                    startDate: startDate,
                    rate: rateValue,
                });

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById("newRateStartDate").value = "";
                document.getElementById("newRateValue").value = "";

                renderRateChangesList();
            }

            /**
             * ä»ä¸´æ—¶æ•°ç»„ä¸­ç§»é™¤ä¸€ä¸ªåˆ©ç‡å˜åŒ–è®°å½•
             * @param {number} index ç´¢å¼•
             */
            function removeRateChange(index) {
                currentRateChanges.splice(index, 1);
                renderRateChangesList();
            }

            /**
             * æ˜¾ç¤ºåˆ›å»º/ç¼–è¾‘è´·æ¬¾ç±»å‹è¡¨å•
             */
            function showCreateLoanTypeForm() {
                // é‡ç½®çŠ¶æ€
                editingTypeId = null;
                currentRateChanges = [];

                document.getElementById("typeName").value = "æ–°ç±»å‹";
                document.getElementById("typeRate").value = "3.5";
                document.getElementById("typeMonths").value = "360";
                document.getElementById("typeStart").value = "2024-01";
                document.getElementById("typeMethod").value =
                    "equalPrincipalInterest";

                renderRateChangesList(); // æ¸²æŸ“ç©ºåˆ—è¡¨
                document
                    .getElementById("create-type-form")
                    .classList.remove("hidden");
            }

            /**
             * éšè—åˆ›å»º/ç¼–è¾‘è´·æ¬¾ç±»å‹è¡¨å•
             */
            function hideCreateLoanTypeForm() {
                document
                    .getElementById("create-type-form")
                    .classList.add("hidden");
            }

            /**
             * ç¼–è¾‘è´·æ¬¾ç±»å‹ï¼šå¡«å……è¡¨å•
             * @param {string} typeId
             */
            function editLoanType(typeId) {
                const type = LOAN_TYPES.find((t) => t.id === typeId);
                if (!type) return;

                editingTypeId = typeId;

                document.getElementById("typeName").value = type.name;
                document.getElementById("typeRate").value = type.rate;
                document.getElementById("typeMonths").value = type.months;
                document.getElementById("typeStart").value = type.start;
                document.getElementById("typeMethod").value = type.method;

                // å¤åˆ¶ rateChanges åˆ°ä¸´æ—¶å˜é‡è¿›è¡Œç¼–è¾‘
                currentRateChanges = JSON.parse(
                    JSON.stringify(type.rateChanges),
                );
                renderRateChangesList();

                document
                    .getElementById("create-type-form")
                    .classList.remove("hidden");
            }

            /**
             * ä¿å­˜è´·æ¬¾ç±»å‹ (æ–°å¢æˆ–ç¼–è¾‘)
             */
            function saveLoanType() {
                const typeName = document.getElementById("typeName").value;
                const typeRate = parseFloat(
                    document.getElementById("typeRate").value,
                );
                const typeMonths = parseInt(
                    document.getElementById("typeMonths").value,
                );
                const typeStart = document.getElementById("typeStart").value;
                const typeMethod = document.getElementById("typeMethod").value;

                if (
                    !typeName ||
                    isNaN(typeRate) ||
                    isNaN(typeMonths) ||
                    !typeStart
                ) {
                    alert("è¯·å¡«å†™å®Œæ•´çš„è´·æ¬¾ç±»å‹ä¿¡æ¯");
                    return;
                }

                const typeData = {
                    name: typeName,
                    rate: typeRate,
                    months: typeMonths,
                    start: typeStart,
                    method: typeMethod,
                    // å°†ä¸´æ—¶ç¼–è¾‘çš„åˆ©ç‡å˜åŒ–ä¿å­˜åˆ°æ•°æ®ä¸­
                    rateChanges: currentRateChanges.sort((a, b) =>
                        a.startDate.localeCompare(b.startDate),
                    ),
                };

                if (editingTypeId) {
                    // ç¼–è¾‘ç°æœ‰ç±»å‹
                    const index = LOAN_TYPES.findIndex(
                        (t) => t.id === editingTypeId,
                    );
                    if (index !== -1) {
                        LOAN_TYPES[index] = {
                            ...LOAN_TYPES[index],
                            ...typeData,
                        };
                    }
                } else {
                    // æ–°å¢ç±»å‹
                    const newType = { id: "t" + nextTypeId++, ...typeData };
                    LOAN_TYPES.push(newType);
                }

                hideCreateLoanTypeForm();
                renderLoanTypes();
            }

            /**
             * åˆ é™¤è´·æ¬¾ç±»å‹
             * @param {string} typeId
             */
            function deleteLoanType(typeId) {
                // è­¦å‘Šï¼šå¦‚æœæ­¤ç±»å‹æ­£åœ¨è¢«æˆ‘çš„è´·æ¬¾ä½¿ç”¨ï¼Œåº”é˜»æ­¢åˆ é™¤æˆ–ç»™å‡ºè­¦å‘Šã€‚
                if (
                    MY_LOANS.some((loan) =>
                        loan.subItems.some((sub) => sub.typeId === typeId),
                    )
                ) {
                    alert(
                        "æ­¤è´·æ¬¾ç±»å‹æ­£åœ¨è¢«â€œæˆ‘çš„è´·æ¬¾â€ä½¿ç”¨ï¼Œè¯·å…ˆç§»é™¤ç›¸å…³è´·æ¬¾åˆ†é¡¹åå†åˆ é™¤ï¼",
                    );
                    return;
                }

                if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è´·æ¬¾ç±»å‹å—ï¼Ÿ")) {
                    LOAN_TYPES = LOAN_TYPES.filter((t) => t.id !== typeId);
                    renderLoanTypes();
                }
            }

            // --- (å…¶ä»– MyLoan ç›¸å…³çš„å‡½æ•°ä¿æŒä¸å˜ï¼Œä¸ºèŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œåªä¿ç•™ä¸Šé¢æ–°å¢å’Œä¿®æ”¹çš„) ---

            /**
             * æ¸²æŸ“æˆ‘çš„è´·æ¬¾åˆ—è¡¨è§†å›¾
             */
            function renderMyLoansView() {
                document
                    .getElementById("type-library-view")
                    .classList.remove("hidden");
                document
                    .getElementById("my-loans-view")
                    .classList.remove("hidden");
                document
                    .getElementById("create-loan-form")
                    .classList.add("hidden");
                document
                    .getElementById("loan-detail-view")
                    .classList.add("hidden");

                const list = document.getElementById("loan-list");
                list.innerHTML = "";
                MY_LOANS.forEach((loan) => {
                    const div = document.createElement("div");
                    div.className = "loan-list-item";
                    div.innerHTML = `
                        <div>
                            <strong>${loan.name}</strong><br>
                            æ€»é‡‘é¢: ${loan.totalAmount} ä¸‡å…ƒ
                        </div>
                        <div>
                            <button onclick="showLoanDetails('${loan.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                            <button style="background-color: #dc3545;" onclick="deleteMyLoan('${loan.id}')">åˆ é™¤</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            /**
             * æ˜¾ç¤ºåˆ›å»ºæˆ‘çš„è´·æ¬¾è¡¨å•
             */
            function showCreateMyLoanForm() {
                document
                    .getElementById("create-loan-form")
                    .classList.remove("hidden");
                document
                    .getElementById("my-loans-view")
                    .classList.add("hidden");
                document
                    .getElementById("type-library-view")
                    .classList.add("hidden");
            }

            /**
             * ä¿å­˜æˆ‘çš„è´·æ¬¾
             */
            function saveMyLoan() {
                const name = document.getElementById("myLoanName").value;
                const amount = parseFloat(
                    document.getElementById("myLoanAmount").value,
                );

                if (!name || isNaN(amount) || amount <= 0) {
                    alert("è¯·å¡«å†™æœ‰æ•ˆçš„è´·æ¬¾åç§°å’Œé‡‘é¢");
                    return;
                }

                const newLoan = {
                    id: "l" + nextLoanId++,
                    name: name,
                    totalAmount: amount,
                    subItems: [],
                };

                MY_LOANS.push(newLoan);
                showLoanDetails(newLoan.id);
            }

            /**
             * åˆ é™¤æˆ‘çš„è´·æ¬¾
             * @param {string} loanId
             */
            function deleteMyLoan(loanId) {
                if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è´·æ¬¾ç»„åˆå—ï¼Ÿ")) {
                    MY_LOANS = MY_LOANS.filter((l) => l.id !== loanId);
                    renderMyLoansView();
                }
            }

            /**
             * è¿›å…¥è´·æ¬¾è¯¦æƒ…é¡µ
             * @param {string} loanId
             */
            function showLoanDetails(loanId) {
                currentLoanId = loanId;
                const loan = MY_LOANS.find((l) => l.id === loanId);
                if (!loan) return;

                document
                    .getElementById("type-library-view")
                    .classList.add("hidden");
                document
                    .getElementById("my-loans-view")
                    .classList.add("hidden");
                document
                    .getElementById("create-loan-form")
                    .classList.add("hidden");
                document
                    .getElementById("loan-detail-view")
                    .classList.remove("hidden");

                document.getElementById("detail-loan-name").textContent =
                    loan.name + " - è¯¦æƒ…";
                document.getElementById("detail-total-amount").textContent =
                    loan.totalAmount;

                renderSubItems(loan);
                calculateAndRenderDetails();
            }

            /**
             * æ¸²æŸ“è´·æ¬¾åˆ†é¡¹
             * @param {object} loan
             */
            function renderSubItems(loan) {
                const container = document.getElementById("loan-subitems");
                container.innerHTML = "";
                const typeOptions = LOAN_TYPES.map(
                    (t) =>
                        `<option value="${t.id}">${t.name} (R:${t.rate}%, M:${t.months})</option>`,
                ).join("");

                loan.subItems.forEach((item, index) => {
                    const div = document.createElement("div");
                    div.style.border = "1px dashed #ccc";
                    div.style.padding = "10px";
                    div.style.marginBottom = "10px";
                    div.innerHTML = `
                        <p><strong>åˆ†é¡¹ ${index + 1}</strong></p>
                        <div class="input-group">
                            <label>è´·æ¬¾ç±»å‹:</label>
                            <select id="subItemType-${item.id}" onchange="updateSubItemType('${item.id}', this.value)">
                                <option value="">-- é€‰æ‹©è´·æ¬¾ç±»å‹ --</option>
                                ${typeOptions}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>è´·æ¬¾é‡‘é¢ (ä¸‡å…ƒ):</label>
                            <input type="number" id="subItemAmount-${item.id}" value="${item.amount}" step="0.1"
                                   onchange="updateSubItemAmount('${item.id}', parseFloat(this.value))">
                        </div>
                        <div class="input-group">
                            <label>æå‰è¿˜æ¬¾ (ä¸‡å…ƒ):</label>
                            <input type="number" id="subItemPrepay-${item.id}" value="${item.prepayment[0]?.amount || 0}" step="0.1">
                            <label>å¹´æœˆ:</label>
                            <input type="month" id="subItemPrepayMonth-${item.id}" value="${item.prepayment[0]?.month || ""}">
                        </div>
                        <button onclick="deleteSubItem('${item.id}')" style="background-color: #dc3545;">åˆ é™¤åˆ†é¡¹</button>
                    `;
                    container.appendChild(div);
                    // ç¡®ä¿ select é€‰ä¸­å½“å‰å€¼
                    document.getElementById(`subItemType-${item.id}`).value =
                        item.typeId;
                });

                // æ ¡éªŒæ€»é¢æ˜¯å¦åŒ¹é…
                const currentTotal = loan.subItems.reduce(
                    (sum, item) => sum + item.amount,
                    0,
                );
                if (currentTotal.toFixed(2) !== loan.totalAmount.toFixed(2)) {
                    const warning = document.createElement("p");
                    warning.style.color = "red";
                    warning.textContent = `è­¦å‘Šï¼šåˆ†é¡¹æ€»é¢ (${currentTotal.toFixed(2)} ä¸‡å…ƒ) ä¸æ€»è´·æ¬¾é‡‘é¢ (${loan.totalAmount} ä¸‡å…ƒ) ä¸åŒ¹é…ï¼`;
                    container.prepend(warning);
                }
            }

            /**
             * æ·»åŠ è´·æ¬¾åˆ†é¡¹
             */
            function addSubItem() {
                const loan = MY_LOANS.find((l) => l.id === currentLoanId);
                if (!loan) return;

                loan.subItems.push({
                    id: "s" + Date.now(), // ç®€æ˜“å”¯ä¸€ID
                    typeId: LOAN_TYPES[0] ? LOAN_TYPES[0].id : "", // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªç±»å‹
                    amount: 0,
                    prepayment: [],
                });
                renderSubItems(loan);
            }

            /**
             * æ›´æ–°åˆ†é¡¹çš„è´·æ¬¾ç±»å‹
             */
            function updateSubItemType(itemId, newTypeId) {
                const loan = MY_LOANS.find((l) => l.id === currentLoanId);
                const subItem = loan.subItems.find((s) => s.id === itemId);
                if (subItem) subItem.typeId = newTypeId;
            }

            /**
             * æ›´æ–°åˆ†é¡¹çš„è´·æ¬¾é‡‘é¢
             */
            function updateSubItemAmount(itemId, newAmount) {
                const loan = MY_LOANS.find((l) => l.id === currentLoanId);
                const subItem = loan.subItems.find((s) => s.id === itemId);
                if (subItem) subItem.amount = newAmount;
            }

            /**
             * åˆ é™¤è´·æ¬¾åˆ†é¡¹
             */
            function deleteSubItem(itemId) {
                const loan = MY_LOANS.find((l) => l.id === currentLoanId);
                loan.subItems = loan.subItems.filter((s) => s.id !== itemId);
                renderSubItems(loan);
            }

            /**
             * æ ¸å¿ƒè®¡ç®—å’Œæ¸²æŸ“è¿˜æ¬¾æ˜ç»†
             */
            function calculateAndRenderDetails() {
                const loan = MY_LOANS.find((l) => l.id === currentLoanId);
                if (!loan) return;

                // 1. æ±‡æ€»æ‰€æœ‰åˆ†é¡¹çš„è¿˜æ¬¾è®¡åˆ’
                let combinedScheduleMap = new Map(); // Key: YYYY-MM
                let totalInterestSum = 0;

                loan.subItems.forEach((item) => {
                    const type = LOAN_TYPES.find((t) => t.id === item.typeId);
                    if (!type || item.amount <= 0) return;

                    // æ”¶é›†æå‰è¿˜æ¬¾æ•°æ® (ä» UI è¯»å–)
                    const prepayMonth = document.getElementById(
                        `subItemPrepayMonth-${item.id}`,
                    ).value;
                    const prepayAmount =
                        parseFloat(
                            document.getElementById(`subItemPrepay-${item.id}`)
                                .value,
                        ) || 0;
                    const itemPrepayments = [];
                    // æ¯æ¬¡è®¡ç®—æ—¶ï¼Œæ›´æ–° item.prepayment æ•°æ®ï¼Œæ–¹ä¾¿åç»­è°ƒè¯•
                    item.prepayment = [];
                    if (prepayAmount > 0 && prepayMonth) {
                        itemPrepayments.push({
                            month: prepayMonth,
                            amount: prepayAmount,
                        });
                        item.prepayment.push({
                            month: prepayMonth,
                            amount: prepayAmount,
                        });
                    }

                    // è°ƒç”¨æŠ½è±¡çš„è®¡ç®—é€»è¾‘
                    const { schedule, totalInterest } =
                        LoanCalculator.calculateSchedule(
                            item.amount * 10000, // è½¬æ¢ä¸ºå…ƒ
                            type.months,
                            type.start,
                            type.method,
                            type.rate / 100, // åŸºç¡€åˆ©ç‡è½¬æ¢ä¸ºå°æ•°
                            type.rateChanges, // ä¼ å…¥åˆ©ç‡å˜åŒ–
                            itemPrepayments,
                        );

                    totalInterestSum += totalInterest;

                    // åˆå¹¶è¿˜æ¬¾è®¡åˆ’
                    schedule.forEach((monthDetail) => {
                        const dateKey = monthDetail.date;
                        if (!combinedScheduleMap.has(dateKey)) {
                            combinedScheduleMap.set(dateKey, {
                                monthlyRepayment: 0,
                                principalRepayment: 0,
                                interest: 0,
                                totalRemainingPrincipal: 0,
                            });
                        }

                        const combined = combinedScheduleMap.get(dateKey);
                        combined.monthlyRepayment +=
                            monthDetail.monthlyRepayment;
                        combined.principalRepayment +=
                            monthDetail.principalRepayment;
                        combined.interest += monthDetail.interest;
                        // å‰©ä½™æœ¬é‡‘åªå–å½“å‰åˆ†é¡¹çš„æœ€æ–°å‰©ä½™æœ¬é‡‘ï¼Œå¹¶ç›¸åŠ 
                        combined.totalRemainingPrincipal +=
                            monthDetail.remainingPrincipal;
                    });
                });

                // 2. æ¸²æŸ“ç»“æœ

                // æ¸²æŸ“æ‘˜è¦
                const totalRepay = loan.totalAmount * 10000 + totalInterestSum;
                document.getElementById("summary-interest").textContent =
                    totalInterestSum.toFixed(2);
                document.getElementById("summary-total-repay").textContent =
                    totalRepay.toFixed(2);

                // æ¸²æŸ“æ˜ç»†è¡¨
                const tableBody = document.getElementById("repayment-schedule");
                tableBody.innerHTML = "";

                // æŒ‰æ—¶é—´æ’åº
                const sortedKeys = Array.from(
                    combinedScheduleMap.keys(),
                ).sort();

                sortedKeys.forEach((dateKey, index) => {
                    const detail = combinedScheduleMap.get(dateKey);
                    const row = tableBody.insertRow();

                    row.insertCell().textContent = index + 1; // æœŸæ•°
                    row.insertCell().textContent = dateKey; // å¹´æœˆ
                    row.insertCell().textContent =
                        detail.monthlyRepayment.toFixed(2); // æœˆè¿˜æ¬¾é¢
                    row.insertCell().textContent =
                        detail.principalRepayment.toFixed(2); // è¿˜æ¬¾æœ¬é‡‘
                    row.insertCell().textContent = detail.interest.toFixed(2); // è¿˜æ¬¾åˆ©æ¯
                    row.insertCell().textContent =
                        detail.totalRemainingPrincipal.toFixed(2); // å‰©ä½™æœ¬é‡‘
                });

                if (sortedKeys.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 6;
                    cell.textContent = "è¯·æ·»åŠ è´·æ¬¾åˆ†é¡¹å¹¶é‡æ–°è®¡ç®—ã€‚";
                    cell.style.textAlign = "center";
                }
            }

            // --- é¡µé¢åˆå§‹åŒ– ---
            document.addEventListener("DOMContentLoaded", () => {
                renderLoanTypes();
                renderMyLoansView();
            });
        </script>
    </body>
</html>
